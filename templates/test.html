{% extends 'base.html' %}

{% block page_title %}

    <title>Testing parts Table</title>

{% endblock %}

{% block style %}
<style>
    .table-container {
        max-height: 300px; /* Adjust the scrollable table height */
        overflow-y: auto;
    }
    .loading { 
        text-align: center; font-weight: bold; padding: 20px; display: none; 
    }
</style>
{% endblock %}

{% block admin_name %}
  <div>{{ admin_name }}</div>
{% endblock %}

{% block content_title %}

    <h2 class="page-title">
        Testing Parts table
    </h2>

{% endblock %}

{% block main_content %}
<!-- Filtering Section -->
<div class="mb-3">
    <label for="filter" class="form-label">Filter by:</label>
    <select id="filter" class="form-select">
        <option value="no_filter">No Filter</option>
        <optgroup label="Part Name">
            <option value="partname_asc">Ascending</option>
            <option value="partname_desc">Descending</option>
        </optgroup>
        <optgroup label="Quantity">
            <option value="quantity_high">High Order</option>
            <option value="quantity_low">Low Order</option>
        </optgroup>
        <optgroup label="Reason">
            <option value="reason" data-reason="Not required">Not Required</option>
            <option value="reason" data-reason="Faulty">Faulty</option>
            <option value="reason" data-reason="Surcharge">Surcharge</option>
        </optgroup>
        <optgroup label="Account Number">
            <option value="account_asc">Ascending</option>
            <option value="account_desc">Descending</option>
        </optgroup>
        <optgroup label="Credited">
            <option value="credited_yes">Yes</option>
            <option value="credited_no">No</option>
        </optgroup>
        <optgroup label="Created At">
            <option value="created_at_asc">Ascending</option>
            <option value="created_at_desc">Descending</option>
        </optgroup>
    </select>
</div>
<!-- Table -->
<div class="table-container">
    <div class="loading" id="loading" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
    <table class="table table-striped table-bordered">
        <thead class="table-dark">
            <tr>
                <th>ID</th><th>Part Name</th><th>Quantity</th><th>Reason</th>
                <th>Account Number</th><th>Company</th><th>Unique ID</th>
                <th>Added By</th><th>Credited</th><th>Created At</th><th>Updated At</th>
            </tr>
        </thead>
        <tbody id="parts-table-body">
            <!-- Rows will be populated here -->
        </tbody>
    </table>
</div>

{% endblock %}

{% block js_content %}
<!-- JavaScript -->
<script>
    document.getElementById('filter').addEventListener('change', function () {
        const filterType = this.value;
        const reason = this.options[this.selectedIndex].getAttribute('data-reason') || '';

        console.log(reason)

        const tableBody = document.getElementById('table-body');
        const loading = document.getElementById('loading');

        // Get the current page number from the URL
        const urlParams = new URLSearchParams(window.location.search);
        const currentPage = urlParams.get('page') || 1; // Default to page 1 if `page` is not present
        console.log(currentPage)

        // Show loading animation
        tableBody.innerHTML = '';
        loading.style.display = 'block';

        fetch('/filter_parts', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ filter_type: filterType, filter_value: reason, page: currentPage })
        })
        .then(response => response.json())
        .then(data => {
            loading.style.display = 'none';
            if (data.error) {
                tableBody.innerHTML = `<tr><td colspan="11">Error: ${data.error}</td></tr>`;
            } else {
                tableBody.innerHTML = data.data.map(part => `
                    <tr>
                        <td>${part[0]}</td>
                        <td>${part[1]}</td>
                        <td>${part[2]}</td>
                        <td>${part[3]}</td>
                        <td>${part[4]}</td>
                        <td>${part[5]}</td>
                        <td>${part[6]}</td>
                        <td>${part[7]}</td>
                        <td>${part[8] ? 'Yes' : 'No'}</td>
                        <td>${part[9]}</td>
                        <td>${part[10]}</td>
                    </tr>
                `).join('');
            }
        });
    });
</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
    // Automatically fetch data with "No Filter" on page load
    const filterType = 'no_filter'; // Default filter type
    const filterValue = '';         // No specific value for "No Filter"

    // Get the current page number from the URL
    const urlParams = new URLSearchParams(window.location.search);
    const currentPage = urlParams.get('page') || 1; // Default to page 1 if `page` is not present

    // Prepare the request body
    const requestBody = {
        filter_type: filterType,
        filter_value: filterValue,
        page: currentPage
    };

    // Fetch data and populate the table
    fetch('/filter_parts', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(requestBody)
    })
    .then(response => response.json())
    .then(data => {
        console.log('Data fetched on page load:', data);
        populateTable(data.data); // Function to update the table with received data
    })
    .catch(error => {
        console.error('Error fetching data on page load:', error);
    });
});

// Function to populate the table with data
function populateTable(data) {
    const tableBody = document.querySelector('#parts-table-body'); // Assuming your table has this ID
    tableBody.innerHTML = ''; // Clear existing rows

    data.forEach(part => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${part[0]}</td>
            <td>${part[1]}</td>
            <td>${part[2]}</td>
            <td>${part[3]}</td>
            <td>${part[4]}</td>
            <td>${part[5]}</td>
            <td>${part[6]}</td>
            <td>${part[7]}</td>
            <td>${part[8] === 1 ? 'Yes' : 'No'}</td>
            <td>${new Date(part[9]).toLocaleString()}</td>
            <td>${new Date(part[10]).toLocaleString()}</td>
        `;
        tableBody.appendChild(row);
    });
}

</script>
{% endblock %}
</body>
</html>
